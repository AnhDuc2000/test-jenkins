Clone Confluence 5.9.5 from Production to Pentest
=================================================

Clone MySQL DB from Production to Pentest (20 min)
--------------------------------------------------
	AWS Prod
		Go to RDS > Instance
			Select "cz-mysqldb"
				on "Instance actions"
					select "Take snapshot"
						Name the snapshot "cz-mysqldb-confluence-2-pentest-2018-07-01"
				
		goto to RDS > Snapshots
			search snapshot "cz-mysqldb-confluence-2-pentest-2018-07-01" with filter "Owned by Me"
			select found "cz-mysqldb-confluence-2-pentest-2018-07-01"
					On "Actions"
						select "Share Snapshot"
						
			db snapshot = 6 mins
			db snapshot share = 1 mins
		
	AWS Pentest
		Go to RDS > Snapshots
			Filter snapshots by "All Public Snapshots" 
				Search for Snapshots "cz-mysqldb-confluence-2-pentest-2018-07-01"
				Select the found snapshot "cz-mysqldb-confluence-2-pentest-2018-07-01"
					On "Actions"
						select "Restore Snapshot" 
						
							DB Engine = MySQL Community Edition
							License Model = general-public-license
							DB Instance Class = db.t2.medium -- 2 vCPU, 4 GiB RAM
							Multi-AZ Deployment = No
							Storage type = General Purpose (SSD)
							DB Instance Identifier = pentest-confluence-20180701
							Virtual Private Cloud (VPC) = Default VPC (vpc-b4d3e7d0)
							Subnet group = default
							Public accessibility = Yes
							Availability zone = us-east-1a
							Option Group = default:mysql-5-6
							Copy tags to snapshots = No
							Log exports = (No selection needed because it is on Pentest)
							Maintenance = Yes
							
								Process Status:
									creating	= 5:19pm --> 5:23pm
									backing-up	= 5:23pm --> 5:25pm
									modifying	= 5:25pm --> 5:26pm
						
			Create a backup (snapshot) before migrating the MySQL db from 5.6.27 to 5.6.39.
				Create a snapshot of "pentest-confluence-20180701" and name it as "pentest-confluence-20180701-mysql-5-6-27" before upgrading to MySQL 5.6.39" (1:59 pm - 2:00pm) (note snapshot will retain within time limited (7days?).  If we want to keep it for longer, then need to create a backup db instance of it.
					Create a db instance from this snapshot (5:32 pm --   -- backing-up (1.47 pm -- 1:53pm) -- modifying (1:53 pm - 1:54pm)
						On "Actions"
							select "Restore Snapshot" 
								** Follow the steps above and set "DB Instance Identifier = pentest-confluence-20180701-mysql-5-6-27"							


​				
Clone Confluence 5.9.5 from Production to Pentest (10 min)
----------------------------------------------------------
	Go to prod node1 (pub:52.73.177.83  -- prt:10.0.0.197) and zip folder "/opt/atlassian"  (Note: to prevent files locked, it is better to stop Confluence when zipping this folder)
		cd /opt
		tar -czvf atlassian-5.9.5-node1.tar.gz atlassian 		(6:47pm -- 6:51 pm)	
		
	copy the zip file to node 1 on Confluence pentest linux server (pub:18.233.217.63 -- prt:172.31.77.44)
		scp -i /home/ec2-user/devcloud-pentest-useast1.pem /opt/atlassian-5.9.5-node1.tar.gz ec2-user@18.233.217.63:/tmp 		(6:53 pm - 6:54 pm)


​	
Clone the EFS of Confluence 5.9.5 to Pentest (~ 4 hours)
--------------------------------------------------------
	Go to prod node 3 backup (Public DNS(IPv4)=ec2-54-210-129-196.compute-1.amazonaws.com) and copy the "/efs-bak" to pentest node 1.  
	
	Before doing this, 
		- disable rsync job in 'crontab'
		- confirm there is no existing folder "confluence-shared-home" and the user "ec2-user" has full access to this folder "/efs" on pentest node 1. If you get permission error, create a temp folder under "/efs" and grant full permission for this temp folder and scp to this temp folder.
					
		sudo su		
		scp -ri /home/ec2-user/devcloud-pentest-useast1.pem /efs-bak ec2-user@18.233.217.63:/efs
			
	After done, enable rsync job on prod node 3


​	
Setup Confluence 5.9.5 on Pentest
---------------------------------	
	Go to pentest node 1 (pub:18.233.217.63		prt:172.31.77.44)
		sudo su
		cd /opt
		cp /tmp/atlassian-5.9.5-node1.tar.gz .
		chown root:root atlassian-5.9.5-node1.tar.gz
	
	make sure no confluence instance is running.  If yes, then stop it
	make sure there is no folder "atlassian" in this folder "/opt".  If yes, then rename it.	
	extract the tar file and make sure the tar file is owned by root after copied	
	(6:55pm - 6:57pm)
		tar -xzvf atlassian-5.9.5-node1.tar.gz
	
	confirm the owner 'confluence' on the extracted folders "/opt/atlassian/confluence-data"
		
	change cluster configuration file (4 min)
		vi /opt/atlassian/confluence-data/confluence.cfg.xml
			from:
				<property name="confluence.cluster.peers">10.0.0.197,10.0.0.245</property>
				<property name="confluence.setup.server.id">B86M-QIKQ-CZ9U-4BPT</property>
				<property name="hibernate.connection.url">jdbc:mysql://cz-mysqldb.cb53usaz5oke.us-east-1.rds.amazonaws.com/confluence_db?sessionVariables=storage_engine%3DInnoDB</property>
	
			to:	
				<property name="confluence.cluster.peers">172.31.77.44,172.31.72.159</property>
				<property name="confluence.setup.server.id">B49Q-A7IE-E18K-EYDO</property>
				<property name="hibernate.connection.url">jdbc:mysql://pentest-confluence-20180701.ceu54difvuaw.us-east-1.rds.amazonaws.com/confluence_db?sessionVariables=storage_engine%3DInnoDB</property>

	change tomcat server config to proxyName "jirapentest.dxcdevcloud.net" (2 min)
		vi /opt/atlassian/confluence/conf/server.xml					
			from:
				<Connector port="8080" proxyName="confluence.csc.com" proxyPort="443" scheme="https" secure="true" connectionTimeout="20000" redirectPort="8443"
			
			to:
				<Connector port="8090" proxyName="confluencepentest.dxcdevcloud.net" proxyPort="443" scheme="https" secure="true" connectionTimeout="20000" redirectPort="8443"
			
	Rebuilding the Content Indexes from Scratch by deleting the content of these two folders (3 min)
		cd /opt/atlassian/confluence-data/index
		rm -rf *
		
		this folder "journal" contains a lot of files so need to delete the whole folder and recreate it.  Otherwise, you might get error
			cd /opt/atlassian/confluence-data
			rm -rf journal
			mkdir journal
			chown confluence:confluence journal
			chmod 700 journal
			
	Remove files in plugin cache folders.  (2 min)
		cd /opt/atlassian/confluence-data/bundled-plugins
		rm -rf *
		
		cd /opt/atlassian/confluence-data/plugins-cache
		rm -rf *
		
		cd /opt/atlassian/confluence-data/plugins-osgi-cache
		rm -rf *
		
		cd /opt/atlassian/confluence-data/plugins-temp
		rm -rf *
		
	Remove files in temp folder (1 min)
		cd /opt/atlassian/confluence-data/temp
		rm -rf *
				
	Remove files in Tomcat logs folder and Confluence data logs folder (2 min)
		cd /opt/atlassian/confluence-data/logs
		rm -rf *
	
		cd /opt/atlassian/confluence/logs
		rm -rf *
		
	Increase the max backup log file to 25 so we can have records of all activities and not overwritten by default of 5 files 
		vi /opt/atlassian/confluence/confluence/WEB-INF/classes/log4j.properties
		log4j.appender.confluencelog.MaxBackupIndex=25


​		
MySQL DB
--------
	(3 min)
	Programmatically changing Server Base URL
	When copy the product to pentest, the prod is using the SAML Plugin which has configuration to redirect to the based URL and you can not login to Pentest.  So need 
	to change the SERVER Base URL to get into the JIRA pentest.
		
		update BANDANA set BANDANAVALUE = replace(BANDANAVALUE, 'https://confluence.csc.com', 'https://confluencepentest.dxcdevcloud.net') where BANDANACONTEXT = '_GLOBAL' and BANDANAKEY = 'atlassian.confluence.settings';
	
	Change Server ID	
		update BANDANA set bandanavalue = '<string>B49Q-A7IE-E18K-EYDO</string>' where bandanakey = 'confluence.server.id' and BANDANAID <> 0;	


Start Confluence on node 1 with v5.9.5
--------------------------------------
	Putty on node 1 
		sudo su
		service confluence start
	
	***if you get 502 gateway error, it could be AWS load balance redirect to unhealthy node.  Make sure you have one node in the target group "confluence" of the load balancer and remove unhealthy node out of this target group.
	
	***Check Confluence log file and confirm everything is working fine.
	
	The following needs to be login as user "Administrator" on both Confluence and Jira to create application link
	
		Change Server Base URL to https://confluencepentest.dxcdevcloud.net
			Go to "Confluence administration"
			Click on "General Configuration"
				Change "Server Base URL" to "https://confluencepentest.dxcdevcloud.net"
	
		Disable "Secure administrator sessions"
			Go to "Confluence administration"		
			Click on Security Configuration
			Uncheck the box "Secure administrator sessions"
		
		Fix the application link between Jira and Confluence on Pentest		
			(For screenshots, see doc "Connect pentest Confluence 5.9.5 to Jira 7.2.9 pentest Configuration.docx")
			On Confluence:		
				Click on "Application Links"		
				Delete the existing Application that links to Production JIRA URL
				Create new link to Pentest JIRA URL
					You are creating a link from:	
						Display URL: https://jirapentest.dxcdevcloud.net
						Application URL: https://jirapentest.dxcdevcloud.net
						Name: JIRA
						Application: JIRA
	
					To this application:					
						Display URL: https://confluencepentest.dxcdevcloud.net
						Application URL: https://confluencepentest.dxcdevcloud.net
						Name: Confluence
						Application: Confluence
						
					Checked box:	The servers have the same set of users and usernames. If unsure leave unchecked.
						
					Checked box:	I am an administrator on both instances.
			
			On Jira:
				Go to "Administration"
				Click on "User management"
				Click on "JIRA user server"
					Confirm you have the following.  Make sure the IP Address has the public and private of Confluence pentest node.
						Application name	IP Addresses	
							confluence		172.31.74.198																			172.31.77.44
											18.233.217.63
											52.22.25.217
		
			On Confluence:
				Go to "Confluence administration"	
				Click on "User Directories"
				Move Directory Name "Confluence Internal Directory" to the top and "JIRA" on the second.
				On "JIRA" Directory Name, click on "Edit"
				On "Server URL", enter "http://172.31.64.246:8080" where "172.31.64.246" is the Private Ip of Jira Node 1.
	
	Disable Plugin "Confluence HipChat Plugin" and "SAML SingleSignOn for Confluence", since it is not compatible with 6.4.3
		Go to "Confluence administration"	
		Click on "Manage add-ons"
		
		Expand "Confluence HipChat Plugin"
		Click on "Disable" button
		
		Expand "SAML SingleSignOn for Confluence"
		Click on "Disable" button
	
	Disable "Back Up Confluence"
		Go to "Confluence administration"
		Click on "Scheduled Jobs"
		For Job Name "Back Up Confluence", click on "Disable"
		
	Stop/Start Confluence to see if there is any errors in the confluence log.
		
		You will see a WARN like "[hipchat.connect.synchronise.ModifyDescriptorSynchronisationActivity".
		You might see a INFO like "synchroniseCache FULL synchronisation complete for directory"
		
	On Confluence, goto "Space Directory" and try to navigate to any spaces and confirm it is working fine.
		Click on Confluence Home Page (Confluence Dashboard)
		Click on "Spaces" --> "Space directory"
			(https://confluencepentest.dxcdevcloud.net/spacedirectory/view.action)
