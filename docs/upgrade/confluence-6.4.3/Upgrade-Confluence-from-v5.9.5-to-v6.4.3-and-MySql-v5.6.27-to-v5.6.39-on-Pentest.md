Upgrade Confluence from v5.9.5 to v6.4.3 and MySql v5.6.27 to v5.6.39 on Pentest 
================================================================================


Done in advance
---------------
	Download Confluence 6.4.3 and MySQL Driver
		wget https://www.atlassian.com/software/confluence/downloads/binary/atlassian-confluence-6.4.3-x64.bin    	
		wget https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-5.1.46.zip


Upgrade MySQL DB from 5.6.27 to 5.6.39
--------------------------------------
	Stop Confluence on node 1 (1 min)
		sudo su
		service confluence stop
	
	Create a new parameter group
		On AWS, goto RDS > Parameter groups	(https://console.aws.amazon.com/rds/home?region=us-east-1#parameter-groups:)
						
			Click on "Create parameter group" button			
				Parameter group family = "mysql5.6"
				Group name = "confluence-mysql"
				Description = "Customize parameter group for MySQL to use by Confluence"
				
				Click on "Create"
				
			Search for "confluence-mysql" and make the following changes
				Change parameter value of "innodb_log_file_size" to 536870912	(512M)
				change parameter value of "max_allowed_packet" to 536870912 	(512M )


	Change DB version with parametr group "confluence-mysql" (30 min upgrade + 3 min reboot to apply update db parameter option)
		On AWS, goto https://console.aws.amazon.com/rds/home?region=us-east-1#dbinstances:
		Find "pentest-confluence-20180701" and click on it
		Scroll down to the middle of the page and click on "Modify" button
		Change "DB engine version"
			From: mysql 5.6.27
			To:	  mysql 5.6.39 (default)
			
		Change "DB parameter group"
			From: "default.mysql5.6"
			To:	  "confluence-mysql"
			
		Click on "Continue" button
		Select "Apply immediately"
		
			Summary of Modifications
				You are about to submit the following modifications. Only values that will change are displayed. Carefully verify your changes and click Modify DB Instance.
				
				Attribute			Current Value			New Value
				---------			-------------			---------
				DB engine version	5.6.27 (MySQL 5.6.27)	5.6.39 (mysql 5.6.39)
				DB parameter group	default.mysql5.6		confluence-mysql
			
		Click on "Modify DB Instance"		
			upgrading 7:43am - 8:05am
			modifying 8:05am - 8:06am
			parameter group 8:06am
				confluence-mysql (pending-reboot) 
		
		Reboot MySQL 
			Select "pentest-confluence-20180701"
			Click on "Instance actions" --> "Reboot" --> "Reboot" button 
				Status: rebooting (8:10am -- 8:11am)
					After the status of db is "Available", in the "parameter group" it should said "confluence-mysql (in-sync)"


​	
Start Confluence on Node 1
--------------------------
	putty to node 1
		sudo su
		service confluence start
	
	check confluence log and confirm no error
		tail -f /opt/atlassian/confluence-data/logs/atlassian-confluence.log

	Goto https://confluencepentest.dxcdevcloud.net/admin/systeminfo.action
	Search for "Database information"
	Confirm 
		"Database version" is "5.6.39-log"
		"Database Driver Version" is "mysql-connector-java-5.1.34"
		"Database Connection URL" is "	jdbc:mysql://pentest-confluence-20180701.ceu54difvuaw.us-east-1.rds.amazonaws.com/confluence_db?sessionVariables=storage_engine%3DInnoDB"
	
	Goto "https://confluencepentest.dxcdevcloud.net/plugins/servlet/cluster-monitoring"
	Confirm Node 1 is running
	
	Check "Instance Health"
		Goto "Confluence administrator"
		click on "Atlassian Support Tools"
		Click on "Instance health"
		
			Make sure verything is passed checks.
				Supported Platforms
				Administration
				Database
	
	On Confluence, goto "Space Directory" and try to navigate to any spaces and confirm it is working fine.
		Click on Confluence Home Page (Confluence Dashboard)
		Click on "Spaces" --> "Space directory"
			(https://confluencepentest.dxcdevcloud.net/spacedirectory/view.action)
			
	Make sure no major errors in the Atlassian log


​	
Upgrade Confluence from v5.9.5 to v6.4.3 on Node 1
--------------------------------------------------			
	0.  Make sure there is not any backup file in the "/opt/atlassian/confluence-data/temp".  Otherwise it will take a lot of time for backing up the confluence folders during upgrade process
		
	1.	Download Confluence Software 6.4.3. (done in advance)
	
	2.	Perform upgrade on 1st node (30 min)
			Putty to Confluence node 1 
				sudo su
				cd /opt
				chmod a+x atlassian-confluence-6.4.3-x64.bin
				./atlassian-confluence-6.4.3-x64.bin
					Unpacking JRE ...
					Starting Installer ...
	
					This will install Confluence 6.4.3 on your computer.
					OK [o, Enter], Cancel [c]
	
					Choose the appropriate installation or upgrade option.
					Please choose one of the following:
					Express Install (uses default settings) [1],
					Custom Install (recommended for advanced users) [2],
					Upgrade an existing Confluence installation [3, Enter]
					3
					Existing installation directory:
					[/opt/atlassian/confluence]
	
					Back Up Confluence Home
					The upgrade process will automatically back up your Confluence Installation
					Directory. You can also choose to back up your existing Confluence Home
					Directory. Both directories are backed up as zip archive files in their
					respective parent directory locations.
	
					We strongly recommend choosing this option in the unlikely event that you
					experience problems with the upgrade and may require these backups to
					restore your existing Confluence installation.
	
					If you have many attachments in your Confluence Home Directory, the zip
					archive of this directory may consume a significant amount of disk space.
					Back up Confluence home ?
					Yes [y, Enter], No [n]
					y
	
					Checking for local modifications.
	
					List of modifications made within Confluence directories.
	
					The following provides a list of file modifications within the confluence
					directory.
	
					Modified files:
							confluence/WEB-INF/web.xml
							bin/setenv.sh
							conf/server.xml
							conf/web.xml
					Removed files:
							(none)
					Added files:
							confluence/printheader.jsp
							confluence/WEB-INF/lib/mysql-connector-java-5.1.34-bin.jar
							bin/setenv.sh.old
							conf/server.xml.old
							conf/server1.xml
							jre/bin/ssl_certificate.p7b
	
					[Enter]


					Checking if your instance of Confluence is running
					Upgrade Check List
					Back up your external database
					We strongly recommend you back up your Confluence database if you have not
					already done so.
	
					Please refer to the following URL for back up guidelines:
					http://docs.atlassian.com/confluence/docs-64/Production+Backup+Strategy
	
					Check plugin compatibility
					Check that your non-bundled plugins are compatible with Confluence 6.4.3.
	
					For more information see our documentation at the following URL:
					http://docs.atlassian.com/confluence/docs-64/Installing+and+Configuring+Plugins+using+the+Universal+Plugin+Manager


					Please ensure you have read the above checklist before upgrading.
					Your existing Confluence installation is about to be upgraded! Do you want to proceed?
					Upgrade [u, Enter], Exit [e]
					u
	
					Your instance of Confluence is currently being upgraded.
					Checking if Confluence has been shutdown...
					Backing up the Confluence installation directory
	
					Backing up the Confluence home directory
	
					Deleting the previous Confluence installation directory...
	
					Extracting files ...


					Please wait a few moments while we configure Confluence.
					Installation of Confluence 6.4.3 is complete
					Start Confluence now?
					Yes [y, Enter], No [n]
					n
					Installation of Confluence 6.4.3 is complete
					Custom modifications
					Your previous Confluence installation contains customisations (eg
					server.xml) that must be manually transferred. Refer to our documentation
					more information:
					http://docs.atlassian.com/confluence/docs-64/Upgrading+Confluence#UpgradingConfluence-custommodifications
					Finishing installation ...
					[root@ip-172-31-77-44 opt]
		
	3.	For MySQL database, download the latest jdbc driver, and place it in <installation-directory>/lib.  (done in advance)		
			Backup old mysql driver
				cd /opt				
				mv /opt/atlassian/confluence/confluence/WEB-INF/lib/mysql-connector-java-5.1.34-bin.jar /opt
				
			Copy new mysql driver
				cp mysql-connector-java-5.1.46-bin.jar /opt/atlassian/confluence/confluence/WEB-INF/lib
				
			Check
				ll /opt/atlassian/confluence/confluence/WEB-INF/lib/mysql-connector-java-5*
		
	4.	Reapply any customizations, like JVM properties, from the old version to the new one. (5 min)
			Modify Tomcat files
				vi /opt/atlassian/confluence/bin/setenv.sh
					Change:
						From:	CATALINA_OPTS="-Xms1024m -Xmx1024m -XX:+UseG1GC ${CATALINA_OPTS}"
						To:	CATALINA_OPTS="-Xms1024m -Xmx4096m -XX:+UseG1GC ${CATALINA_OPTS}"
	
					Add:
						CATALINA_OPTS="-Dconfluence.cluster.node.name=node1 ${CATALINA_OPTS}"
						CATALINA_OPTS="-Dconfluence.upgrade.recovery.file.enabled=false ${CATALINA_OPTS}"
			
			Modify Confluence file
				vi /opt/atlassian/confluence/conf/server.xml
					Change:
						<Connector port="8090" connectionTimeout="20000" redirectPort="8443"
							proxyName="confluencepentest.dxcdevcloud.net"
							proxyPort="443"
							scheme="https"
							secure="true"
							maxThreads="48" minSpareThreads="10"
							enableLookups="false" acceptCount="10" debug="0" URIEncoding="UTF-8"
							protocol="org.apache.coyote.http11.Http11NioProtocol" />
						
			Remove Tomcat and Confluence log files
				rm -rf /opt/atlassian/confluence/logs
				rm -rf /opt/atlassian/confluence-data/logs
	
	5.0 Check disk space available "cat /proc/meminfo" and "top -u confluence" to confirm there is enough memory.  if necessary, stop and start linux node to get more free memory before start Confluence
	
	5.1	Start Confluence. During this step, your database will be upgraded. (20 min – check for any errors in the logs)
			Run this command as root
				service confluence start
				
			Check log files for any errors
				tail -f /opt/atlassian/confluence-data/logs/atlassian-confluence.log				
				
			After you have completed an upgrade, you should see the following message in the atlassian-confluence.log file:
	
				2010-03-08 08:03:58,899 INFO [main] [atlassian.confluence.upgrade.AbstractUpgradeManager]        
					atlassian-confluence.log:2018-07-10 02:47:25,209 INFO [localhost-startStop-1] [atlassian.confluence.upgrade.AbstractUpgradeManager] initialUpgradeFinished Upgrade initial stage completed successfully
			
				(after 1 or 2 min, you should see below message)
					atlassian-confluence.log:2018-07-10 02:49:16,119 INFO [localhost-startStop-1] [atlassian.confluence.upgrade.AbstractUpgradeManager] entireUpgradeFinished Upgrade completed successfully
			
			If you do not see the line in your log similar to the one above, this means that your upgrade may not have completed successfully. Please check our Upgrade Troubleshooting https://confluence.atlassian.com/confkb/upgrade-troubleshooting-180847191.html documentation to check for a suitable recommendation or fix.		
		
			**Note: During the upgrade process, you might see the warning message "java.lang.OutOfMemoryError: Java heap space".  Do not terminate the process and wait for its process to finished, This might take a few minutes.				
		
			**If you see this error in Confluence UI "Confluence cluster node will not start up because the build number in the database [6212] doesn't match either the application build number [7402] or the home directory build number [7402].", it means the upgrade is not successful.  See here for the fix https://confluence.atlassian.com/confkb/confluence-will-not-start-up-because-the-build-number-in-the-home-directory-doesn-t-match-the-build-number-in-the-database-after-upgrade-376834096.html
					
			Check MySQL DB using this "select * from CONFVERSION;" to confirm all the previous versions upgraded successfully like in below
				
					CONFERSIONID	BUILDNUMBER		INSTALLDATE				VERSIONTAG					CREATIONDATE	LASTMODDATE		***VERSION***
					622593		6212		2016-02-24 05:54:57		lock_for_upgrade_to_7402										5.9.5
					113672193	6403		2018-07-15 06:31:51																			
					113672194	6406		2018-07-15 06:31:51																			
					113672195	6412		2018-07-15 06:31:51																			
					113672196	6439		2018-07-15 06:33:01																			
					113672197	7101		2018-07-15 06:33:03																		6.0.1	
					113672198	7104		2018-07-15 06:33:04																		6.0.6	
					113672199	7105		2018-07-15 06:33:05																			
					113672200	7108		2018-07-15 06:33:06																			
					113672201	7109		2018-07-15 06:33:06																	6.1.x	
					113672202	7110		2018-07-15 06:33:06																		6.1.4
					113672203	7202		2018-07-15 06:33:06																		6.3.x
					113672204			7402		2018-07-15 06:33:07																		6.4.x
	
			Check "confluence.cfg.xml" and confirm the build number 7402 is the same as on the database
				vi /opt/atlassian/confluence-data/confluence.cfg.xml
					<buildNumber>7402</buildNumber>
			
			If you see Confluence UI with the error in below, restart Confluence again.  This might due to using the same production license as pentest license.  After Confluence UI is back as normal, apply the "Developer" license.
			
				You cannot access Confluence at present. Look at the table below to identify the reasons.
	
					Type	Description																			Exception										Level		Time
					startup	Pre-Upgrade recovery file generation failed.										Failed to generate recovery file				fatal	2018-07-15 06:23:19
							Please refer to https://confluence.atlassian.com/x/ropKGQ for possible solution.
	
							Your server id is: B49Q-A7IE-E18K-EYDO	
					-----------------------------------------------------------------------------------------------					
					startup	Post-Upgrade recovery file generation failed.										No operations allowed after connection closed.	fatal	2018-07-15 06:34:25
							Please refer to https://confluence.atlassian.com/x/ropKGQ for possible solution.
	
							Your server id is: B49Q-A7IE-E18K-EYDO													
				
			Check Clustering
				Goto "Confluence administrator"
				Click on "Clustering"  (https://confluencepentest.dxcdevcloud.net/plugins/servlet/cluster-monitoring)
				Confirm Node name "node1" is currently running
			
			Check "Instance Health"
				Goto "Confluence administrator"
				click on "Atlassian Support Tools"
				Click on "Instance health" tab
				
					Make sure very thing is passed checks.
	
					Except "Administration" is failed because we use "Administrator" instead of "admin" and both Internal directory and Jira directory have same account of "Administrator".  Ignore this.
					
			Check System Information
				Goto "Confluence administrator"
				Click on "System Information"
				
					Confluence Version:			6.4.3
					Build Number:				7402
					Database version:			5.6.39-log
					Database Driver Version:	mysql-connector-java-5.1.46				
					
			On Confluence, goto "Space Directory" and try to navigate to any spaces and confirm it is working fine.
				Click on Confluence Home Page (Confluence Dashboard)
				Click on "Spaces" --> "Space directory"
					(https://confluencepentest.dxcdevcloud.net/spacedirectory/view.action)
					
			Make sure no major errors in the Atlassian log

	6.	Global Pass – upgrade SAML Configuration (30 min) – need GP team onboard
			i.	Configure SAML Configuration with Global Pass metadata (ACS url, Entity ID, certificate)
			ii. Update files for handling multiple login option (Global Pass and UserName & Password)

	7.	Upgrade Confluence plugins to the supported versions. (5 min)
			
			*****Confluence Integration for Hipchat (*** not compatible with 6.4.3)
					Installed version: 6.31.2    Available version: 7.8.29
					Version 7.8.29 • Confluence Server 5.7 - 6.3.4 • Released 2016-11-29
	
			Draw.io Confluence Plugin
					Installed version: 7.1.2    Available version: 8.0.5
					Version 8.0.5 • Confluence Server 5.10.0 - 6.10.0 • Released 2018-07-10
	
			*****IM Presence NG Plugin
					Installed version: 2.8.3    Available version: 2.8.4
					Version 3.0.0 • Confluence Server 6.1.0 - 6.10.02017-03-28
							Released 2017-03-28 • No Vendor Support • Free • BSD
	
			*****SAML SingleSignOn for Confluence
					Installed version: 0.14.7   Available version: 2.0.11
					Version 2.3.3 • Confluence Server 5.10.0 - 6.10.0 • Released 2018-07-09
	
			Support Tools Plugin
					Installed version: 3.10.6   Available version: 4.0.2
					Version 4.0.2 • Confluence Server 5.9.14 - 6.5.3, 
							Released 2017-12-14 • Supported By Atlassian • Free • BSD
	
			Atlassian Universal Plugin Manager Plugin
					Version: 2.21.5             Available version: 2.22.11
					Confluence Server 5.10.0 - 6.10.0
							Released 2018-06-20
	
	8. Re-Index (40 min)
	
			Test Node 1 While Re-Indexing (in parallel with indexing)
			
			•	Run through checklist of test case
			•	Make go or no-go decision
			•	If no-go, do back-out
			•	If go, continue below – can start Node 2 once go decision is made.
	
	9.	Checking for known issues and troubleshooting the Confluence upgrade
	
		Confluence Post-Upgrade Checklist
		https://confluence.atlassian.com/conf64/confluence-post-upgrade-checks-936511832.html
		
	    1. The editor (Synchrony is not configured for this upgrade)
	            Edit a page to check your browser can connect to Synchrony, which is required for collaborative editing. See Troubleshooting Collaborative Editing if you are not able to edit a page. 
	
	    2. Layout and Menu
	            Visit the Confluence dashboard and check that it is accessible and displays as expected. Test the different Internet browsers that you have in use in your environment. In addition, confirm that the layout appears as expected and that the menus are clickable and functioning.
	
	    3. Search
	            Try searching for content, for example pages, attachments or user names. Check that the expected results are returned.
	
	    4. Permissions
	            Confirm that you can visit a page that has view restrictions, but you have permission to view. Confirm that you can edit a page that has edit restrictions but you have permission to edit. Make sure that the permissions of child pages are functioning as well. Involve as many space administrators as possible to confirm they are working. Confirm that anonymous or forbidden users cannot access or modify restricted pages.
	
	    5. Attachments
	            Confirm that attachments are accessible and searchable.
	
	    6. Add-ons
	            Outdated third-party add-ons can cause upgrade failure. Quite often, they will just be incompatible and simply do not work anymore. If you discover that your add-on is no longer working, please check for the latest version for your add-on in the The Atlassian Marketplace or check for compatibility in the Universal Plugin Manager.

Copy upgraded Confluence v6.4.3 directories on Node 1 to Node 2
--------------------------------------------------------------------------
	The next step is to replicate your upgraded Confluence directories to other nodes in the cluster.  

		1. Stop Confluence on the first node.
		
		2. Copy the installation directory and local home directory from the first node to the next node. (10 min)
			Create tar file
				cd /opt
				tar -czvf atlassian-6.4.3-node5.tar.gz atlassian		3:07pm - 3:11pm
				
			Copy tar file to destination node 5				
				scp -i /home/ec2-user/devcloud-pentest-useast1.pem /opt/atlassian-6.4.3-node5.tar.gz ec2-user@52.73.186.115:/tmp 	
		
			Putty to node 5 and copy tar file to "/opt" folder
				cd /opt
				mv /tmp/atlassian-6.4.3-node5.tar.gz .
				chown root:root atlassian-6.4.3-node5.tar.gz
				tar -xzvf atlassian-6.4.3-node5.tar.gz
			
			Change node name from node1 to node2
				vi /opt/atlassian/confluence/bin/setenv.sh
					change
						from:	CATALINA_OPTS="-Dconfluence.cluster.node.name=node1 ${CATALINA_OPTS}"
						to:		CATALINA_OPTS="-Dconfluence.cluster.node.name=node2 ${CATALINA_OPTS}"		

			Add node 2 Private IP address into Confluence config file
				vi /opt/atlassian/confluence-data/confluence.cfg.xml
					change
						from:	 <property name="confluence.cluster.peers">172.31.74.198</property>
						to:		 <property name="confluence.cluster.peers">172.31.74.198,172.31.72.159</property>
			
			Add node 2 to the target group "confluence"
				Login in to AWS console
				Goto to EC2 --> Target Groups --> Select "confluence" --> click on "Targets" tab
					Click on "Edit" button
					Select "confluence-node2-pentest" --> click on "Add to registered" on port "8090"
					Click on "Save" button			
		
		3. Start Confluence on second node, and confirm that you can log in and view pages on this node.
			service confluence start
								
			Login to Confluence Dashboard and confirm you are login on node2.  This "node2" is displayed in the foot note like "Powered by Atlassian Confluence 6.4.3 (node2: d7c9e5ab)".  Or you check if you are on node2 by goto "Confluence administration" --> Clustering --> Confirm "node2" has circle green and with black bolded color text.
									
		
		4. Start Confluence on first node, and confirm that you can log in and view pages on this node. 
			service confluence start
				
			Login to Confluence Dashboard with different browsers (IE, Egde, Chrome, Firefox) and confirm you are login on node1.  This "node1" is displayed in the foot note like "Powered by Atlassian Confluence 6.4.3 (node1: xxxxxxx)".  Or you can check if you are on node1 by goto "Confluence administration" --> Clustering --> Confirm "node1" has circle green and with black bolded color text.  When the cluster is running properly, you should be able to see the details of each node.
		
		NOTE: Once all nodes have been upgraded you can start Confluence Data Center on each node, one at a time (starting up multiple nodes simultaneously can lead to serious failures).
